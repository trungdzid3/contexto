<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contexto ƒê·∫°i Chi·∫øn</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">
    
    <!-- FIREBASE SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        :root { --primary: #6C5CE7; --bg: #DFE6E9; --card: #fff; --green: #00b894; --yellow: #fdcb6e; --red: #ff7675; }
        * { box-sizing: border-box; font-family: 'Nunito', sans-serif; }
        body { background: var(--bg); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        
        h1 { color: var(--primary); font-weight: 900; margin: 0; font-size: 2rem; }
        .subtitle { color: #636e72; margin-bottom: 20px; font-weight: 700; font-size: 0.9rem; }
        
        /* Screens */
        .screen { display: none; width: 100%; max-width: 480px; flex-direction: column; gap: 15px; }
        .active { display: flex; }

        /* Card */
        .card { background: var(--card); padding: 20px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        
        /* Inputs & Buttons */
        input { width: 100%; padding: 12px 15px; border: 2px solid #eee; border-radius: 10px; font-size: 1rem; outline: none; margin-bottom: 10px; }
        input:focus { border-color: var(--primary); }
        
        button { width: 100%; padding: 12px; border: none; border-radius: 10px; font-weight: 800; cursor: pointer; font-size: 1rem; color: white; transition: 0.2s; margin-bottom: 5px;}
        .btn-primary { background: var(--primary); }
        .btn-green { background: var(--green); }
        button:hover { transform: translateY(-2px); opacity: 0.9; }

        /* Leaderboard UI */
        .room-header { background: #a29bfe; color: white; padding: 15px; border-radius: 15px; display: flex; justify-content: space-between; font-weight: 800; }
        
        .player-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #eee; align-items: center; }
        .player-row:last-child { border-bottom: none; }
        .player-name { font-weight: 700; color: #2d3436; }
        .player-rank { font-weight: 900; color: var(--primary); font-size: 1.1rem; }
        .me { background: #f1f2f6; padding-left: 10px; padding-right: 10px; border-radius: 8px; }

        /* Game Log */
        .game-log { height: 180px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; margin-top: 15px; padding-right: 5px; }
        .log-item { background: #f5f6fa; padding: 8px 12px; border-radius: 8px; display: flex; justify-content: space-between; font-size: 0.9rem; }
        .r-badge { padding: 2px 8px; border-radius: 4px; color: white; font-weight: bold; font-size: 0.8rem; }
        .bg-green { background: var(--green); } .bg-yellow { background: var(--yellow); } .bg-red { background: var(--red); }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 5px; }
    </style>
</head>
<body>

    <h1>Contexto ƒê·∫°i Chi·∫øn</h1>
    <div class="subtitle">ƒê·∫•u tr√≠ c√πng b·∫°n b√®</div>

    <!-- M√ÄN H√åNH 1: S·∫¢NH CH·ªú (LOBBY) -->
    <div id="lobbyScreen" class="screen active">
        <div class="card">
            <h3>üë§ T√™n hi·ªÉn th·ªã</h3>
            <input type="text" id="username" placeholder="Nh·∫≠p t√™n b·∫°n (VD: H√πng B√°)...">
            
            <div style="height: 1px; background: #eee; margin: 20px 0;"></div>
            
            <h3>üè† T·∫°o ho·∫∑c V√†o ph√≤ng</h3>
            <button class="btn-primary" onclick="createRoom()">üëë T·∫°o ph√≤ng m·ªõi</button>
            <div style="text-align: center; margin: 10px; color: #aaa; font-size: 0.8rem;">- HO·∫∂C -</div>
            <input type="text" id="roomIdInput" placeholder="Nh·∫≠p M√£ ph√≤ng (VD: 1234)...">
            <button class="btn-green" onclick="joinRoom()">üöÄ V√†o ph√≤ng ngay</button>
        </div>
    </div>

    <!-- M√ÄN H√åNH 2: TRONG GAME -->
    <div id="gameScreen" class="screen">
        <div class="room-header">
            <span id="displayRoomId">Ph√≤ng: ...</span>
            <span id="displayStatus">ƒêang ch·ªù...</span>
        </div>

        <!-- B·∫£ng x·∫øp h·∫°ng Realtime -->
        <div class="card">
            <h4 style="margin: 0 0 10px 0; color: #636e72;">üèÜ B·∫£ng X·∫øp H·∫°ng</h4>
            <div id="leaderboard"></div>
        </div>

        <!-- Khu v·ª±c ƒëo√°n t·ª´ -->
        <div class="card">
            <div style="display: flex; gap: 10px;">
                <input type="text" id="guessInput" placeholder="Nh·∫≠p t·ª´ ƒëo√°n..." autocomplete="off">
                <button class="btn-primary" style="width: 80px;" onclick="submitGuess()">G·ª≠i</button>
            </div>
            <div id="myMsg" style="text-align: center; color: var(--red); font-weight: bold; margin-top: 5px; min-height: 20px; font-size: 0.9rem;"></div>
        </div>

        <!-- L·ªãch s·ª≠ ƒëo√°n c√° nh√¢n -->
        <div class="game-log" id="gameLog"></div>
    </div>

    <script>
        // ============================================================
        // C·∫§U H√åNH FIREBASE C·ª¶A B·∫†N (ƒê√£ ƒë∆∞·ª£c ƒëi·ªÅn s·∫µn)
        const firebaseConfig = {
            apiKey: "AIzaSyBhAN_r2JpGSAnjapMbbipu1SWMKcUkPaM",
            authDomain: "contexto-vn.firebaseapp.com",
            projectId: "contexto-vn",
            storageBucket: "contexto-vn.firebasestorage.app",
            messagingSenderId: "459236947038",
            appId: "1:459236947038:web:b53cf9bf5af2602344b0cf"
        };
        // ============================================================

        // 1. Kh·ªüi t·∫°o Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Bi·∫øn to√†n c·ª•c
        let myName = "";
        let currentRoomId = "";
        let currentGameId = 1; // ID t·ª´ b√≠ m·∫≠t
        let isWinner = false;

        // --- CH·ª®C NƒÇNG: T·∫†O & V√ÄO PH√íNG ---

        async function createRoom() {
            myName = document.getElementById('username').value.trim();
            if (!myName) return alert("Vui l√≤ng nh·∫≠p t√™n!");

            // Random ID ph√≤ng (4 s·ªë)
            const roomId = Math.floor(1000 + Math.random() * 9000).toString();
            // Random ID m√†n ch∆°i (T·ª´ 1 ƒë·∫øn 500) ƒë·ªÉ m·ªói l·∫ßn ch∆°i l√† m·ªôt t·ª´ m·ªõi
            const randomGameId = Math.floor(Math.random() * 500) + 1;

            try {
                // T·∫°o ph√≤ng tr√™n Firebase
                await db.collection("rooms").doc(roomId).set({
                    gameId: randomGameId,
                    created: firebase.firestore.FieldValue.serverTimestamp(),
                    players: [{ name: myName, bestRank: 99999, guesses: 0, winner: false }]
                });
                enterGame(roomId, randomGameId);
            } catch (e) {
                alert("L·ªói t·∫°o ph√≤ng: " + e.message);
                console.error(e);
            }
        }

        async function joinRoom() {
            myName = document.getElementById('username').value.trim();
            const roomId = document.getElementById('roomIdInput').value.trim();
            if (!myName || !roomId) return alert("Nh·∫≠p ƒë·ªß th√¥ng tin nh√©!");

            try {
                const roomRef = db.collection("rooms").doc(roomId);
                const doc = await roomRef.get();
                
                if (!doc.exists) return alert("Ph√≤ng kh√¥ng t·ªìn t·∫°i!");
                
                // Th√™m ng∆∞·ªùi ch∆°i v√†o ph√≤ng
                const data = doc.data();
                const players = data.players || [];
                
                if(players.some(p => p.name === myName)) return alert("T√™n b·ªã tr√πng, ƒë·ªïi t√™n kh√°c ƒëi!");

                players.push({ name: myName, bestRank: 99999, guesses: 0, winner: false });
                await roomRef.update({ players: players });

                enterGame(roomId, data.gameId);

            } catch (e) {
                alert("L·ªói v√†o ph√≤ng: " + e.message);
                console.error(e);
            }
        }

        function enterGame(roomId, gameId) {
            currentRoomId = roomId;
            currentGameId = gameId;

            document.getElementById('lobbyScreen').classList.remove('active');
            document.getElementById('gameScreen').classList.add('active');
            document.getElementById('displayRoomId').innerText = "Ph√≤ng: " + roomId;

            // B·∫Øt ƒë·∫ßu l·∫Øng nghe d·ªØ li·ªáu Realtime
            listenToRoom();
        }

        // --- REAL-TIME DATA ---

        function listenToRoom() {
            db.collection("rooms").doc(currentRoomId).onSnapshot((doc) => {
                if (!doc.exists) return;
                const data = doc.data();
                renderLeaderboard(data.players);
                
                // Ki·ªÉm tra ng∆∞·ªùi th·∫Øng
                const winner = data.players.find(p => p.winner === true);
                if (winner) {
                    document.getElementById('displayStatus').innerText = `üèÜ ${winner.name} TH·∫ÆNG!`;
                } else {
                    document.getElementById('displayStatus').innerText = "ƒêang di·ªÖn ra...";
                }
            });
        }

        function renderLeaderboard(players) {
            const list = document.getElementById('leaderboard');
            list.innerHTML = "";
            
            // X·∫øp h·∫°ng: Rank nh·ªè nh·∫•t l√™n ƒë·∫ßu
            players.sort((a, b) => a.bestRank - b.bestRank);

            players.forEach(p => {
                const isMe = p.name === myName;
                const rankDisplay = p.bestRank === 99999 ? "--" : "#" + p.bestRank;
                
                const div = document.createElement('div');
                div.className = `player-row ${isMe ? 'me' : ''}`;
                div.innerHTML = `
                    <div>
                        ${p.winner ? 'üëë ' : ''}<span class="player-name">${p.name}</span>
                        <div style="font-size: 0.8rem; color: #666;">${p.guesses} l∆∞·ª£t ƒëo√°n</div>
                    </div>
                    <div class="player-rank">${rankDisplay}</div>
                `;
                list.appendChild(div);
            });
        }

        // --- LOGIC GAME ---

        const guessInput = document.getElementById('guessInput');
        guessInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') submitGuess() });

        async function submitGuess() {
            const word = guessInput.value.trim();
            if (!word || isWinner) return;

            const btn = document.querySelector('#gameScreen .btn-primary');
            btn.disabled = true;
            btn.innerText = "...";

            try {
                // G·ªçi Proxy v·ªõi gameId
                const res = await fetch('/api/proxy_guess', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ word: word, gameId: currentGameId })
                });

                const data = await res.json();
                btn.disabled = false;
                btn.innerText = "G·ª≠i";
                guessInput.value = "";
                guessInput.focus();

                if (data.error) {
                    document.getElementById('myMsg').innerText = data.error;
                    return;
                }

                document.getElementById('myMsg').innerText = "";
                
                // Hi·ªÉn th·ªã log
                addLog(data);

                // C·∫≠p nh·∫≠t Firebase
                await updateStats(data.rank);

                if (data.rank === 1) {
                    isWinner = true;
                    alert("CH√öC M·ª™NG! B·∫†N ƒê√É CHI·∫æN TH·∫ÆNG!");
                }

            } catch (e) {
                btn.disabled = false;
                btn.innerText = "G·ª≠i";
                document.getElementById('myMsg').innerText = "L·ªói m·∫°ng!";
                console.error(e);
            }
        }

        function addLog(data) {
            const log = document.getElementById('gameLog');
            const div = document.createElement('div');
            div.className = 'log-item';
            
            let color = 'bg-red';
            if(data.rank === 1) color = 'bg-green';
            else if(data.rank <= 300) color = 'bg-green';
            else if(data.rank <= 1000) color = 'bg-yellow';

            div.innerHTML = `
                <span>${data.word || data.lemma}</span>
                <span class="r-badge ${color}">#${data.rank}</span>
            `;
            log.insertBefore(div, log.firstChild);
        }

        async function updateStats(rank) {
            const roomRef = db.collection("rooms").doc(currentRoomId);
            
            // D√πng Transaction ƒë·ªÉ c·∫≠p nh·∫≠t d·ªØ li·ªáu an to√†n
            await db.runTransaction(async (transaction) => {
                const doc = await transaction.get(roomRef);
                if (!doc.exists) return;

                const players = doc.data().players;
                const myIndex = players.findIndex(p => p.name === myName);

                if (myIndex !== -1) {
                    players[myIndex].guesses += 1;
                    if (rank < players[myIndex].bestRank) {
                        players[myIndex].bestRank = rank;
                    }
                    if (rank === 1) {
                        players[myIndex].winner = true;
                    }
                    transaction.update(roomRef, { players: players });
                }
            });
        }
    </script>
</body>
</html>
